# Production Environment Variables

## üîê Required Environment Variables for Kubernetes Deployment

These variables are automatically injected by the deployment script into Kubernetes secrets.

---

## **Core Services**

### **Database (PostgreSQL + Citus)**
```bash
DATABASE_URL=postgresql://postgres:<PASSWORD>@postgresql.databases.svc.cluster.local:5432/albion
SUPABASE_URL=http://postgresql.databases.svc.cluster.local:5432
SUPABASE_SERVICE_ROLE_KEY=<auto-generated-during-deployment>
NEXT_PUBLIC_SUPABASE_URL=http://postgresql.databases.svc.cluster.local:5432
NEXT_PUBLIC_SUPABASE_ANON_KEY=<auto-generated-during-deployment>
```

### **Redis (Cache + Sessions)**
```bash
REDIS_URL=redis://:< PASSWORD>@redis-master.databases.svc.cluster.local:6379
REDIS_PASSWORD=<auto-generated-during-deployment>
```

### **Qdrant (Vector Database)**
```bash
QDRANT_URL=http://qdrant.databases.svc.cluster.local:6333
```

### **MinIO (Object Storage)**
```bash
MINIO_ENDPOINT=minio.databases.svc.cluster.local:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=<auto-generated-during-deployment>
```

---

## **Next.js Configuration**

### **Server Actions (Prevents Version Skew)**
```bash
NEXT_SERVER_ACTIONS_ENCRYPTION_KEY=<auto-generated-during-deployment>
```

### **Build Configuration**
```bash
NODE_ENV=production
NEXT_PUBLIC_BUILD_NUMBER=v1.0.0
NEXT_PUBLIC_CACHE_IN_SECONDS=3600
```

---

## **Admin Backend**

### **Authentication (NextAuth)**
```bash
NEXTAUTH_SECRET=<auto-generated-during-deployment>
NEXTAUTH_URL=https://admin.pyro1121.com
```

### **Stripe Payments**
```bash
STRIPE_SECRET_KEY=sk_live_<your-stripe-secret-key>
STRIPE_PUBLISHABLE_KEY=pk_live_<your-stripe-publishable-key>
STRIPE_WEBHOOK_SECRET=whsec_<your-webhook-secret>
```

---

## **External APIs (No Changes Needed)**

### **Albion Online APIs**
```bash
# These are public APIs, no keys needed
GAMEINFO_BASE_URL=https://gameinfo.albiononline.com/api/gameinfo
AODP_BASE_URL=https://west.albion-online-data.com/api/v2
RENDER_BASE_URL=https://render.albiononline.com/v1
```

---

## **CDN Configuration (Optional)**

### **Cloudflare**
```bash
CLOUDFLARE_ACCOUNT_ID=<your-account-id>
CLOUDFLARE_API_TOKEN=<your-api-token>
CLOUDFLARE_ZONE_ID=<your-zone-id>
```

---

## **Monitoring & Observability**

### **Sentry (Error Tracking)**
```bash
SENTRY_DSN=<your-sentry-dsn>
SENTRY_AUTH_TOKEN=<your-sentry-auth-token>
NEXT_PUBLIC_SENTRY_DSN=<your-sentry-dsn>
```

### **Analytics**
```bash
NEXT_PUBLIC_GA_ID=G-<your-google-analytics-id>
```

---

## **GitHub Secrets (For CI/CD)**

Add these to your GitHub repository secrets:

```bash
# Kubernetes Access
KUBE_CONFIG=<base64-encoded-kubeconfig>

# Database
DATABASE_URL=<full-connection-string>
SUPABASE_SERVICE_ROLE_KEY=<service-role-key>

# Redis
REDIS_URL=<full-connection-string>
REDIS_PASSWORD=<password>

# Cloudflare
CLOUDFLARE_ACCOUNT_ID=<account-id>
CLOUDFLARE_API_TOKEN=<api-token>

# Stripe
STRIPE_SECRET_KEY=<secret-key>

# Sentry
SENTRY_AUTH_TOKEN=<auth-token>
```

---

## **How Variables Are Injected**

### **1. During Deployment (Automatic)**
The `deploy-worldclass-hybrid-2025.sh` script automatically:
- ‚úÖ Generates secure passwords for PostgreSQL, Redis, MinIO
- ‚úÖ Generates `NEXT_SERVER_ACTIONS_ENCRYPTION_KEY`
- ‚úÖ Generates `NEXTAUTH_SECRET`
- ‚úÖ Creates Kubernetes secrets with all values
- ‚úÖ Injects secrets into pod deployments

### **2. Manual Secrets (You Provide)**
You need to manually set:
- ‚úÖ `STRIPE_SECRET_KEY` (from Stripe dashboard)
- ‚úÖ `CLOUDFLARE_API_TOKEN` (from Cloudflare dashboard)
- ‚úÖ `SENTRY_DSN` (from Sentry dashboard)

### **3. How to Add Manual Secrets**
```bash
# Add Stripe secret
kubectl create secret generic admin-secrets \
  --from-literal=stripe-secret-key=sk_live_YOUR_KEY \
  --namespace admin

# Add Cloudflare secret
kubectl create secret generic cloudflare-secrets \
  --from-literal=api-token=YOUR_TOKEN \
  --from-literal=account-id=YOUR_ACCOUNT_ID \
  --namespace nextjs

# Add Sentry secret
kubectl create secret generic sentry-secrets \
  --from-literal=dsn=YOUR_DSN \
  --from-literal=auth-token=YOUR_TOKEN \
  --namespace nextjs
```

---

## **Environment Detection (Automatic)**

The application automatically detects the environment:

### **Development (Localhost)**
```typescript
// Automatically uses:
DATABASE_URL=http://localhost:54321
REDIS_URL=redis://localhost:6379
QDRANT_URL=http://localhost:6333
```

### **Production (Kubernetes)**
```typescript
// Automatically uses:
DATABASE_URL=postgresql.databases.svc.cluster.local:5432
REDIS_URL=redis-master.databases.svc.cluster.local:6379
QDRANT_URL=qdrant.databases.svc.cluster.local:6333
```

**No configuration changes needed!** The code detects `KUBERNETES_SERVICE_HOST` and switches automatically.

---

## **Security Best Practices**

### **‚úÖ DO:**
- Store secrets in Kubernetes secrets (encrypted at rest)
- Use GitHub secrets for CI/CD
- Rotate secrets regularly (every 90 days)
- Use strong passwords (32+ characters)
- Enable TLS for all external connections

### **‚ùå DON'T:**
- Commit secrets to Git
- Hardcode secrets in code
- Share secrets in Slack/Discord
- Use weak passwords
- Expose secrets in logs

---

## **Verification Commands**

### **Check Kubernetes Secrets**
```bash
# List all secrets
kubectl get secrets -n databases
kubectl get secrets -n nextjs
kubectl get secrets -n admin

# View secret (base64 encoded)
kubectl get secret postgresql-credentials -n databases -o yaml

# Decode secret
kubectl get secret postgresql-credentials -n databases -o jsonpath='{.data.password}' | base64 -d
```

### **Test Database Connection**
```bash
# From inside a pod
kubectl exec -it nextjs-app-0 -n nextjs -- env | grep DATABASE_URL

# Test connection
kubectl exec -it postgresql-0 -n databases -- psql -U postgres -d albion -c "SELECT 1;"
```

### **Test Redis Connection**
```bash
# From inside a pod
kubectl exec -it redis-master-0 -n databases -- redis-cli ping

# Test with password
kubectl exec -it redis-master-0 -n databases -- redis-cli -a $(kubectl get secret redis -n databases -o jsonpath='{.data.redis-password}' | base64 -d) ping
```

---

## **Troubleshooting**

### **Problem: Pod can't connect to database**
```bash
# Check if secret exists
kubectl get secret postgresql-credentials -n databases

# Check if pod has secret mounted
kubectl describe pod nextjs-app-0 -n nextjs | grep -A 10 "Environment"

# Check DNS resolution
kubectl exec -it nextjs-app-0 -n nextjs -- nslookup postgresql.databases.svc.cluster.local
```

### **Problem: Redis connection fails**
```bash
# Check Redis status
kubectl get pods -n databases | grep redis

# Check Redis logs
kubectl logs redis-master-0 -n databases

# Test connection
kubectl exec -it redis-master-0 -n databases -- redis-cli ping
```

### **Problem: Next.js build fails**
```bash
# Check if NEXT_SERVER_ACTIONS_ENCRYPTION_KEY is set
kubectl get secret nextjs-secrets -n nextjs -o jsonpath='{.data.encryption-key}' | base64 -d

# If missing, regenerate:
kubectl create secret generic nextjs-secrets \
  --from-literal=encryption-key=$(openssl rand -hex 32) \
  --namespace nextjs \
  --dry-run=client -o yaml | kubectl apply -f -
```

---

## **Summary**

‚úÖ **Auto-Generated (by deployment script):**
- PostgreSQL password
- Redis password
- MinIO credentials
- NEXT_SERVER_ACTIONS_ENCRYPTION_KEY
- NEXTAUTH_SECRET

‚úÖ **Manual (you provide):**
- STRIPE_SECRET_KEY
- CLOUDFLARE_API_TOKEN
- SENTRY_DSN

‚úÖ **No Changes Needed:**
- External Albion APIs (public)
- Development environment (uses localhost)

**All secrets are stored securely in Kubernetes and never committed to Git!** üîê
